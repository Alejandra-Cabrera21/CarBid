<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel del Vendedor - CarBid</title>
  <link rel="stylesheet" href="css/panel-vendedor.css">
  <!-- Para que el script pueda tocar el DOM sin problemas -->
<script defer>
  document.addEventListener('DOMContentLoaded', async () => {
    const API_BASE = 'http://localhost:3000/api';

    // 1) Recuperar sesi√≥n
    const uStr = localStorage.getItem('usuario');
    let uObj   = uStr ? JSON.parse(uStr) : null;
    let userId = localStorage.getItem('userId') || (uObj && uObj.id);
    let userName = localStorage.getItem('userName') || (uObj && uObj.nombre);

    if (!userId) { window.location.href = 'login.html'; return; }

    // üëà NUEVO: marcar rol activo y bloquear acceso si no es vendedor
    localStorage.setItem('rolActual', 'vendedor');
    if (!uObj || uObj.es_vendedor !== 'S') {
      try {
        const r = await fetch(`${API_BASE}/usuario/${encodeURIComponent(userId)}`);
        if (r.ok) {
          uObj = await r.json();
          localStorage.setItem('usuario', JSON.stringify(uObj));
        }
      } catch {}
    }
    if (!uObj || uObj.es_vendedor !== 'S') {
      // Elige a d√≥nde quieres mandarlo si no es vendedor:
      // window.location.replace('panel-comprador.html');
      window.location.replace('login.html');
      return;
    }
    // /NUEVO

    // 3) Link a "Mi perfil"
    const aPerfil = document.querySelector('nav.menu a[href="perfil.html"]');
    if (aPerfil) aPerfil.href = `perfil.html?id=${encodeURIComponent(userId)}`;

    // 4) Si no hay nombre, pedirlo
    if (!userName) {
      try {
        const r = await fetch(`${API_BASE}/usuario/${encodeURIComponent(userId)}`);
        if (r.ok) {
          const u = await r.json();
          userName = u.nombre || '';
          localStorage.setItem('usuario', JSON.stringify({ ...(uObj||{}), ...u }));
          if (userName) localStorage.setItem('userName', userName);
        }
      } catch {}
    }

    // 5) Pintar saludo
    const spanNombre = document.getElementById('nombreUsuario');
    if (spanNombre) spanNombre.textContent = userName?.trim() || (uObj && uObj.correo) || 'Usuario';

    // 6) Salir
    const aSalir = document.querySelector('nav.menu a[href="index.html"]');
    if (aSalir) {
      aSalir.addEventListener('click', () => {
        localStorage.removeItem('rolActual');
        localStorage.removeItem('userId');
        localStorage.removeItem('userName');
        localStorage.removeItem('token');
        localStorage.removeItem('usuario');
      });
    }
  });
</script>

</head>

<body>
  <!-- üîπ Header superior -->
  <header class="navbar">
    <div class="logo">
      <img src="img/logo.png" alt="CarBid" />
    </div>
    <nav class="menu">
      <a href="historial-pujas.html">Historial Pujas</a>
      <a href="perfil.html">Mi perfil</a>
      <a href="index.html">Salir</a>
    </nav>
  </header>

  <!-- üîπ Contenido principal -->
  <main class="panel-container">
    <h2>Bienvenid@ <span id="nombreUsuario">...</span></h2>
    <div class="botones">
      <button onclick="window.location.href='crear-publicacion.html'">Crear publicaci√≥n</button>
      <button onclick="window.location.href='mis-subastas.html'">Listado de subastas creadas</button>
    </div>
  </main>
</body>
</html>
