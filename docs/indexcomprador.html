<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CarBidSubastas</title>
  <style>
    :root{
      --bg:#111; --panel:#0f0f0f; --card:#171717; --border:#2a2a2a; --fg:#fff; --muted:#cbd5e1;
      --brand:#1e40af; --brand-hover:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Arial}
    body{overflow-x:hidden}

    /* ========== Header ========== */
    header{
      position:sticky; top:0; z-index:50;
      background:var(--panel);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px 16px;
    }
    header .left{display:flex; align-items:center; gap:10px; min-width:0}
    header .left img{height:40px; flex:0 0 auto}
    header .left strong{white-space:nowrap}
    header .left input{
      padding:8px 10px; border-radius:10px; border:1px solid var(--border);
      width:280px; max-width:48vw; background:#fff; color:#111;
    }
    header .right{display:flex; align-items:center; gap:18px; flex:0 0 auto}
    header a{color:#fff; text-decoration:none; white-space:nowrap}

    /* Campana */
    #bell{
      position:relative; cursor:pointer; background:transparent; border:none; padding:0;
      display:inline-flex; align-items:center; justify-content:center;
      width:28px; height:28px;
    }
    #bell svg{width:24px; height:24px; stroke:#fff; fill:none}
    #notif-count{
      position:absolute; top:-6px; right:-8px;
      min-width:18px; height:18px; padding:0 5px;
      background:#ef4444; color:#fff; border-radius:999px;
      font-size:12px; line-height:18px; text-align:center;
    }

    /* Dropdown notificaciones (más alto para que no se oculte) */
    #notif-box{
      position:absolute; right:10px; top:60px;
      background:#1f2937; color:#fff; border-radius:10px; padding:10px;
      display:none; flex-direction:column; gap:8px;
      width:min(320px, 94vw); max-height:70vh; overflow:auto;
      box-shadow:0 12px 24px rgba(0,0,0,.35);
      z-index:10000; /* evita que lo tape el contenido */
    }
    .notif-empty{ text-align:center; font-size:13px; color:#9ca3af; padding:6px 2px}

    .notif-item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:#374151; padding:8px 10px; border-radius:8px; font-size:14px;
    }
    .notif-item .txt{flex:1 1 auto; min-width:0}
    .notif-item .txt b{white-space:nowrap}
    .notif-del{
      background:transparent; border:none; cursor:pointer; padding:4px; flex:0 0 auto;
      display:inline-flex; align-items:center; justify-content:center; border-radius:6px;
    }
    .notif-del:hover{background:rgba(255,255,255,.08)}
    .notif-del svg{width:18px; height:18px; stroke:#fff; fill:none}

    /* Toast */
    #toast{
      position: fixed; bottom: 25px; right: 25px;
      background: #166534; color: #fff; padding: 12px 16px;
      border-radius: 8px; box-shadow: 0 0 12px rgba(0,0,0,0.4);
      opacity: 0; transform: translateY(20px); transition: all .35s ease; z-index: 9999;
    }
    #toast.show{opacity:1; transform:translateY(0)}

    /* Contenido */
    .wrap{max-width:1100px; margin:24px auto; padding:0 12px}
    h1{font-weight:700; margin:10px 0 24px}
    .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:20px}

    /* Tarjeta: borde blanco y texto a la izquierda */
    .card{background:var(--card); border:1px solid #fff; border-radius:12px; padding:16px; text-align:left}
    .muted{color:var(--muted); margin:2px 0; word-break:break-word}
    /* botón Pujar a la derecha */
    .card .row{display:flex; justify-content:flex-end; align-items:center; margin-top:8px; gap:10px}

    button{background:var(--brand); border:none; color:#fff; border-radius:8px; padding:8px 12px; cursor:pointer}
    button:hover{background:var(--brand-hover)}
    button[disabled]{opacity:.6; cursor:not-allowed}
    img{max-width:100%; border-radius:8px; object-fit:cover; height:220px}

    /* Slider */
    .slider{position:relative; overflow:hidden}
    .slider button{
      position:absolute; top:50%; transform:translateY(-50%);
      background:rgba(0,0,0,.6); border:none; color:#fff;
      font-size:20px; padding:5px 10px; cursor:pointer
    }
    .slider button.prev{left:5px}
    .slider button.next{right:5px}

    /* Dialogo de puja */
    #dialog{position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:10}
    #dialog .box{background:#fff; color:#000; padding:20px; border-radius:10px; min-width:min(380px, 92vw); text-align:center}
    #dialog input{width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:8px}

    /* Responsive */
    @media (max-width:820px){
      header .left input{max-width:44vw}
      header .right{gap:12px}
    }
    @media (max-width:560px){
      header{flex-wrap:wrap; row-gap:10px}
      header .left{width:100%}
      header .left input{max-width:100%; flex:1}
      header .right{width:100%; justify-content:space-between}
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <img src="img/logo.png" alt="CarBid">
      <input type="text" id="search" placeholder="Buscar... 🔍" aria-label="Buscar vehículo">
    </div>

    <div class="right">
      <a href="historial.html">Historial Subastas</a>
      <a href="perfil.html">Mi perfil</a>
      <a href="index.html">Salir</a>

      <!-- Campana con contador -->
      <button id="bell" aria-label="Notificaciones">
        <svg viewBox="0 0 24 24" stroke-width="1.8" aria-hidden="true">
          <path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.172V11a6 6 0 1 0-12 0v3.172a2 2 0 0 1-.6 1.428L4 17h5"/>
          <path d="M9 17v1a3 3 0 0 0 6 0v-1"/>
        </svg>
        <span id="notif-count">0</span>
      </button>

      <div id="notif-box" role="menu" aria-label="Notificaciones"></div>
    </div>
  </header>

  <main class="wrap">
    <h1>Subastas abiertas</h1>
    <div id="list" class="grid"></div>
  </main>

  <!-- Diálogo de puja -->
  <div id="dialog" role="dialog" aria-modal="true">
    <div class="box">
      <h3>Ingresar oferta</h3>
      <input type="number" id="oferta" placeholder="Monto en Q"/>
      <div class="row" style="gap:8px">
        <button id="btnAceptar">Aceptar</button>
        <button type="button" onclick="cerrarDialog()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  <script>
    const API = 'http://localhost:3000/api';
    const FAST_POLL_MS = 10000; // 🔁 refresco más rápido (10s)

    const list = document.getElementById('list');
    const dialog = document.getElementById('dialog');
    const inpOferta = document.getElementById('oferta');
    const btnAceptar = document.getElementById('btnAceptar');
    const bell = document.getElementById('bell');
    const notifBox = document.getElementById('notif-box');
    const bellCount = document.getElementById('notif-count');
    const toast = document.getElementById('toast');
    const search = document.getElementById('search');

    let idSubastaActual = null;
    // notifs = [{text:string}]
    let notifs = [];
    // timers para contadores
    const timers = {};

    /* ===== Toast ===== */
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    /* ===== Utilidades contador ===== */
    function fmtQ(n){ return "Q" + Number(n ?? 0).toLocaleString(); }
    function two(n){ return String(n).padStart(2,'0'); }
    function startCountdown(cardId, finISO){
      const lbl = document.querySelector(`#${cardId} .countdown`);
      const btn = document.querySelector(`#${cardId} .btn-pujar`);
      if(!lbl) return;

      function tick(){
        const target = new Date(finISO).getTime();
        const diff = target - Date.now();
        if(diff <= 0){
          lbl.textContent = 'Finalizada';
          btn?.setAttribute('disabled','disabled');
          clearInterval(timers[cardId]);
          return;
        }
        const t = Math.floor(diff/1000);
        const d = Math.floor(t/86400);
        const h = Math.floor((t%86400)/3600);
        const m = Math.floor((t%3600)/60);
        const s = t%60;
        lbl.textContent = `${d}d ${two(h)}:${two(m)}:${two(s)} restantes`;
      }
      tick();
      timers[cardId] = setInterval(tick, 1000);
    }

    /* ===== Notificaciones ===== */
    function renderNotifs(){
      notifBox.innerHTML = '';
      if(notifs.length === 0){
        notifBox.innerHTML = '<div class="notif-empty">Sin notificaciones</div>';
        bellCount.textContent = 0;
        return;
      }
      notifs.forEach((n, i) => {
        const el = document.createElement('div');
        el.className = 'notif-item';
        el.innerHTML = `
          <div class="txt">${n.text}</div>
          <button class="notif-del" aria-label="Eliminar notificación" onclick="deleteNotif(${i})">
            <svg viewBox="0 0 24 24" stroke-width="1.8">
              <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
              <path d="M10 11v6M14 11v6"/>
            </svg>
          </button>
        `;
        notifBox.appendChild(el);
      });
      bellCount.textContent = notifs.length;
    }

    async function deleteNotif(idx){
      const token = localStorage.getItem("token");
      const notif = notifs[idx];
      if (!notif || !notif.id_subasta) return;

      try {
        const r = await fetch(`${API}/notificaciones/${notif.id_subasta}`, {
          method: "DELETE",
          headers: { "Authorization": "Bearer " + token }
        });
        if (r.ok) {
          showToast("🗑️ Notificación eliminada");
          notifs.splice(idx,1);
          renderNotifs();
        } else {
          const data = await r.json();
          console.warn("⚠️ No se eliminó:", data.message);
          showToast("⚠️ Error al eliminar");
        }
      } catch (err) {
        console.error("❌ Error al eliminar notificación:", err);
        showToast("❌ No se pudo eliminar");
      }
    }

    // Actualiza SIEMPRE el contador; re-renderiza lista solo si está abierto
    let panelOpen = false;
    function setBellCount(n){ bellCount.textContent = n; }

    async function loadNotificaciones(){
      const token = localStorage.getItem("token");
      if (!token){
        setBellCount(0);
        return;
      }
      try {
        const r = await fetch(`${API}/notificaciones?t=${Date.now()}`, {
          headers: { "Authorization": "Bearer " + token },
          cache: "no-store"
        });
        if (!r.ok) throw new Error("Error al cargar notificaciones");
        const data = await r.json();
        // data: [{id_subasta, marca, modelo, monto, fecha}]
        notifs = data.map(n => ({
          id_subasta: n.id_subasta,
          text: `🏁 Ganaste <b>${n.marca} ${n.modelo}</b> por Q${Number(n.monto).toLocaleString()}`
        }));
        setBellCount(notifs.length);
        if (panelOpen) renderNotifs();
      } catch (err) {
        console.error("❌ Notificaciones:", err);
      }
    }

    // Abrir / cerrar panel
    bell.addEventListener('click', async () => {
      panelOpen = notifBox.style.display !== 'flex';
      notifBox.style.display = panelOpen ? 'flex' : 'none';
      if (panelOpen){
        renderNotifs();         // pinta lo que ya hay
        await loadNotificaciones(); // y trae lo nuevo
      }
    });
    // Cerrar si hago click fuera
    document.addEventListener('click', (e) => {
      if (!notifBox.contains(e.target) && !bell.contains(e.target)) {
        notifBox.style.display = 'none';
        panelOpen = false;
      }
    });
    // Esc para cerrar
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        notifBox.style.display = 'none';
        panelOpen = false;
      }
    });

    /* ===== Subastas ===== */
    function createSlider(imagenes){
      if(!imagenes || !imagenes.length) return '<img src="img/no-image.png" alt="Sin imagen">';
      const id = 'slider_' + Math.random().toString(36).substring(2,7);
      window.slides = window.slides || {};
      window.slides[id] = { imgs: imagenes, idx: 0 };
      return `
        <div class="slider" id="${id}">
          <img src="http://localhost:3000${imagenes[0].url}" alt="imagen">
          <button class="prev" onclick="moveSlide('${id}',-1)" aria-label="Anterior">‹</button>
          <button class="next" onclick="moveSlide('${id}',1)" aria-label="Siguiente">›</button>
        </div>
      `;
    }

    function moveSlide(id, dir){
      const s = window.slides[id];
      if(!s) return;
      s.idx = (s.idx + dir + s.imgs.length) % s.imgs.length;
      const el = document.querySelector('#'+id+' img');
      el.src = 'http://localhost:3000' + s.imgs[s.idx].url;
    }

    function card(sub){
      const el = document.createElement('div');
      el.className = 'card';
      const cardId = 'sub_' + sub.id;
      el.id = cardId;

      const titulo = `${sub.marca ?? ''} ${sub.modelo ?? ''} ${sub.anio ?? ''}`.trim();
      const finExacto = new Date(sub.fin).toLocaleString();

      el.innerHTML = `
        ${createSlider(sub.imagenes)}
        <div class="muted" style="font-weight:700; margin-top:8px">${titulo}</div>

        <div class="muted"><b>Marca:</b> ${sub.marca ?? '-'}</div>
        <div class="muted"><b>Modelo:</b> ${sub.modelo ?? '-'}</div>
        <div class="muted"><b>Año:</b> ${sub.anio ?? '-'}</div>
        ${sub.descripcion ? `<div class="muted"><b>Descripción:</b> ${sub.descripcion}</div>` : ""}

        <div class="muted"><b>Precio base:</b> ${fmtQ(sub.precio_base)}</div>
        <div class="muted"><b>Oferta más alta:</b> ${fmtQ(sub.oferta_max || 0)}</div>

        <div class="muted" title="Cierra: ${finExacto}">
          <b>Cierra en:</b> <span class="countdown">--:--</span>
        </div>

        <div class="row">
          <button class="btn-pujar" onclick="abrirDialog(${sub.id})">Pujar</button>
        </div>
      `;
      // Activar contador tras pintar
      requestAnimationFrame(() => startCountdown(cardId, sub.fin));
      return el;
    }

    async function load(term=''){
      const r = await fetch(API + '/subastas?estado=ABIERTA');
      let data = await r.json();
      if(term){
        const t = term.toLowerCase();
        data = data.filter(s => (s.marca + ' ' + s.modelo + ' ' + (s.descripcion || '')).toLowerCase().includes(t));
      }
      for(let s of data){
        const resImg = await fetch(`${API}/subastas/${s.id}`);
        const det = await resImg.json();
        s.imagenes = det.imagenes || [];
        s.descripcion = det.subasta.descripcion;
        s.oferta_max = det.oferta_actual;
      }

      // limpiar contadores previos
      Object.values(timers).forEach(clearInterval);

      list.innerHTML = '';
      data.forEach(s => list.appendChild(card(s)));
    }
    load();
    search.addEventListener('input', e => load(e.target.value));

    function abrirDialog(id){
      idSubastaActual = id;
      dialog.style.display = 'flex';
      inpOferta.value = '';
      inpOferta.focus();
    }
    function cerrarDialog(){
      dialog.style.display = 'none';
      idSubastaActual = null;
    }

    btnAceptar.onclick = async () => {
      const monto = parseFloat(inpOferta.value);
      if (!monto || monto <= 0) return showToast("Monto inválido");
      const token = localStorage.getItem("token");
      if (!token) return showToast("No hay sesión activa. Inicia sesión.");
      try {
        const r = await fetch(`${API}/pujas`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
          body: JSON.stringify({ id_subasta: idSubastaActual, monto })
        });
        const data = await r.json();
        if (r.ok) {
          showToast("✅ Puja registrada correctamente");
          cerrarDialog();
          load();
        } else showToast("⚠️ " + (data.message || "Error desconocido"));
      } catch (err) {
        showToast("❌ No se pudo conectar con el servidor.");
      }
    };

    /* ===== WebSocket ===== */
    const socket = io('http://localhost:3000',{transports:['websocket']});
    socket.on('auction:created', () => load());
    socket.on('auction:closed', () => load());
    socket.on('auction:bid', () => load());
    socket.on('auction:updated', () => load());
    socket.on('auction:won', async (data) => {
      await loadNotificaciones(); // 👈 refresca en caliente cuando gane
      showToast(`Ganaste la subasta #${data.id_subasta}`);
    });

    /* ===== Auto-refresh notificaciones más rápido ===== */
    setInterval(loadNotificaciones, FAST_POLL_MS);
    window.addEventListener('focus', loadNotificaciones);
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) loadNotificaciones();
    });
    loadNotificaciones(); // carga inicial rápida
  </script>
</body>
</html>
