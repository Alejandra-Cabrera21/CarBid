<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Historial de Pujas - CarBid</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --bg:#1b1b1b; --card:#111; --text:#fff; --muted:#cbd5e1; --brand:#ef4444;
      --table-border:#262626; --table-head:#ef4444;
      --chip:#222; --chip-bd:#2c2c2c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue","Noto Sans","Liberation Sans",Arial}
    /* Topbar */
    .topbar{display:flex;align-items:center;justify-content:space-between;
      padding:12px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
    .back{display:inline-flex;align-items:center;gap:8px;color:#fff;text-decoration:none;font-weight:600}
    .logo{height:36px}

    .wrap{max-width:1100px;margin:0 auto;padding:26px 14px 60px}
    h1{text-align:center;margin:8px 0 20px;font-size:clamp(22px,3.4vw,32px)}

    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}

    /* Controles */
    .controls{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:0 0 12px 0
    }
    .controls .group{display:flex;gap:8px;align-items:center}
    .controls label{color:var(--muted);font-size:.92rem}
    .controls select,.controls input{
      background:var(--chip);color:#fff;border:1px solid var(--chip-bd);
      border-radius:8px;padding:8px 10px;outline:none
    }

    /* Tabla (desktop/tablet) */
    .table-wrap{width:100%}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    thead th{
      background:var(--table-head); color:#fff; font-weight:700; padding:12px; text-align:left;
      border:1px solid var(--table-border);
    }
    tbody td{
      background:#0d0d0d; color:#e5e7eb; padding:11px 12px; border:1px solid var(--table-border);
      word-break:break-word;
    }
    tbody tr:hover td{background:#121212}
    th:nth-child(1), td:nth-child(1){width:38%}
    th:nth-child(2), td:nth-child(2){width:22%}
    th:nth-child(3), td:nth-child(3){width:14%; text-align:right}
    th:nth-child(4), td:nth-child(4){width:14%}
    th:nth-child(5), td:nth-child(5){width:12%}
    .vehiculo{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Tarjetas (móvil) */
    .cards{display:none}
    .card-item{
      background:#0d0d0d;border:1px solid var(--table-border);border-radius:12px;
      padding:12px;display:flex;flex-direction:column;gap:8px
    }
    .card-item + .card-item{margin-top:10px}
    .ci-top{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .ci-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ci-name{color:var(--muted);font-size:.95rem}
    .ci-row{display:flex;gap:12px;flex-wrap:wrap}
    .chip{
      background:var(--chip);border:1px solid var(--chip-bd);border-radius:999px;
      padding:4px 10px;font-size:.85rem;color:#fff
    }

    .state{color:var(--muted);text-align:center;padding:18px 8px}

    /* Paginación */
    .pager{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-top:14px; flex-wrap:wrap;
    }
    .pager .left, .pager .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pager button{
      background:#222; color:#fff; border:1px solid #2c2c2c; padding:8px 12px; border-radius:8px; cursor:pointer;
    }
    .pager button[disabled]{opacity:.4; cursor:not-allowed}
    .pager .info{color:var(--muted); font-size:.95rem}

    /* Responsive switches */
    @media (max-width: 720px){
      th:nth-child(1), td:nth-child(1){width:40%}
      th:nth-child(2), td:nth-child(2){width:24%}
      th:nth-child(3), td:nth-child(3){width:16%}
      th:nth-child(4), td:nth-child(4){width:12%}
      th:nth-child(5), td:nth-child(5){width:8%}
      td, th{font-size:.95rem}
    }
    @media (max-width: 640px){
      .table-wrap{display:none}
      .cards{display:block}
    }
    @media (max-width: 480px){
      .logo{height:30px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <a class="back" href="javascript:history.back()"><i class="fa fa-arrow-left"></i> Regresar</a>
    <img class="logo" src="img/logo.png" alt="CarBid">
  </div>

  <div class="wrap">
    <h1>Historial de Pujas</h1>

    <div class="card">
      <!-- Controles de orden/búsqueda -->
      <div class="controls">
        <div class="group">
          <label for="sortBy">Ordenar por:</label>
          <select id="sortBy">
            <option value="fecha">Fecha</option>
            <option value="monto">Monto</option>
            <option value="vehiculo">Vehículo</option>
            <option value="nombre">Nombre</option>
          </select>
          <select id="sortDir">
            <option value="desc">Desc</option>
            <option value="asc">Asc</option>
          </select>
        </div>
        <div class="group">
          <label for="q">Buscar:</label>
          <input id="q" type="search" placeholder="vehículo o nombre…">
        </div>
      </div>

      <div id="info" class="state">Cargando pujas…</div>

      <!-- Tabla (desktop/tablet) -->
      <div class="table-wrap" style="display:none" id="tableWrap">
        <table id="tabla">
          <thead>
            <tr>
              <th>Vehículo</th>
              <th>Nombre</th>
              <th>Oferta (Q)</th>
              <th>Fecha</th>
              <th>Hora</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="pager">
          <div class="left">
            <button id="prevBtn" disabled>&laquo; Anterior</button>
            <button id="nextBtn" disabled>Siguiente &raquo;</button>
          </div>
          <div class="right">
            <span class="info" id="pageInfo">—</span>
          </div>
        </div>
      </div>

      <!-- Tarjetas (móvil) -->
      <div class="cards" id="cards" style="display:none"></div>
    </div>
  </div>

  <!-- Socket.IO del backend -->
  <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  <script>
(function () {
  const info      = document.getElementById('info');
  const tableWrap = document.getElementById('tableWrap');
  const tbody     = document.getElementById('tbody');
  const cardsWrap = document.getElementById('cards');

  const prevBtn   = document.getElementById('prevBtn');
  const nextBtn   = document.getElementById('nextBtn');
  const pageInfo  = document.getElementById('pageInfo');

  const sortBySel = document.getElementById('sortBy');
  const sortDirSel= document.getElementById('sortDir');
  const qInput    = document.getElementById('q');

  const tokenStr = localStorage.getItem('token') || '';
  const token    = tokenStr ? JSON.parse(JSON.stringify(tokenStr)) : null;

  const pageSize = 5; // 5 en todas las vistas
  let currentPage = 1;
  let rows = [];
  let viewRows = [];

  const fmtGTQ  = new Intl.NumberFormat('es-GT', { maximumFractionDigits: 0 });
  const fmtDate = new Intl.DateTimeFormat('es-GT', { dateStyle: 'medium' });
  const fmtTime = new Intl.DateTimeFormat('es-GT', { hour: '2-digit', minute: '2-digit' });

  function normalize(r){
    const d = r.created_at ? new Date(r.created_at) : null;
    return {
      vehiculo: (r.vehiculo || 'Publicación'),
      nombre:   (r.nombre_postor || r.postor || '—'),
      monto:    Number(r.oferta || r.monto || 0),
      fecha:    r.fecha ? r.fecha : (d ? fmtDate.format(d) : ''),
      hora:     r.hora  ? r.hora  : (d ? fmtTime.format(d) : ''),
      createdAt: d ? d.getTime() : 0
    };
  }

  function computeView(){
    const q = qInput.value.trim().toLowerCase();
    const by = sortBySel.value;
    const dir= sortDirSel.value;

    viewRows = rows
      .map(normalize)
      .filter(x => {
        if(!q) return true;
        return (x.vehiculo.toLowerCase().includes(q) || x.nombre.toLowerCase().includes(q));
      });

    const mul = dir === 'asc' ? 1 : -1;
    viewRows.sort((a,b)=>{
      if(by === 'monto') return (a.monto - b.monto) * mul;
      if(by === 'vehiculo') return a.vehiculo.localeCompare(b.vehiculo) * mul;
      if(by === 'nombre') return a.nombre.localeCompare(b.nombre) * mul;
      return (a.createdAt - b.createdAt) * mul;
    });
  }

  function renderTable(slice){
    tbody.innerHTML = slice.map(r => `
      <tr>
        <td class="vehiculo" title="${r.vehiculo}">${r.vehiculo}</td>
        <td>${r.nombre}</td>
        <td style="text-align:right">Q${fmtGTQ.format(r.monto)}</td>
        <td>${r.fecha}</td>
        <td>${r.hora}</td>
      </tr>
    `).join('');
  }

  function renderCards(slice){
    cardsWrap.innerHTML = slice.map(r => `
      <div class="card-item">
        <div class="ci-top">
          <div class="ci-title" title="${r.vehiculo}">${r.vehiculo}</div>
          <div class="chip">Q${fmtGTQ.format(r.monto)}</div>
        </div>
        <div class="ci-name">${r.nombre}</div>
        <div class="ci-row">
          <span class="chip"><i class="fa-regular fa-calendar"></i> ${r.fecha}</span>
          <span class="chip"><i class="fa-regular fa-clock"></i> ${r.hora}</span>
        </div>
      </div>
    `).join('');
  }

  function renderPage(keepPage=false){
    const total = viewRows.length;
    const pages = Math.max(1, Math.ceil(total / pageSize));
    if (!keepPage && currentPage > pages) currentPage = pages;
    if (currentPage < 1) currentPage = 1;

    const start = (currentPage - 1) * pageSize;
    const slice = viewRows.slice(start, start + pageSize);

    const isMobile = window.matchMedia('(max-width: 640px)').matches;
    if (isMobile){
      cardsWrap.style.display = '';
      tableWrap.style.display = 'none';
      renderCards(slice);
    } else {
      tableWrap.style.display = '';
      cardsWrap.style.display = 'none';
      renderTable(slice);
    }

    const showingFrom = total ? start + 1 : 0;
    const showingTo   = start + slice.length;
    pageInfo.textContent = `Mostrando ${showingFrom}–${showingTo} de ${total}`;
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= pages;

    // 🔹 Mover paginador debajo de cards si es móvil
    if (isMobile && !document.querySelector('.cards + .pager')) {
      cardsWrap.insertAdjacentElement('afterend', document.querySelector('.pager'));
    } else if (!isMobile && !document.querySelector('#tableWrap .pager')) {
      document.querySelector('#tableWrap').appendChild(document.querySelector('.pager'));
    }
  }

  prevBtn.addEventListener('click', () => { currentPage--; renderPage(true); });
  nextBtn.addEventListener('click', () => { currentPage++; renderPage(true); });

  sortBySel.addEventListener('change', ()=>{ currentPage=1; computeView(); renderPage(); });
  sortDirSel.addEventListener('change', ()=>{ currentPage=1; computeView(); renderPage(); });
  qInput.addEventListener('input', ()=>{ currentPage=1; computeView(); renderPage(true); });
  window.addEventListener('resize', ()=> renderPage(true));

  async function fetchData(){
    const res = await fetch('http://localhost:3000/api/historial-pujas', {
      headers: { 'Authorization': token ? `Bearer ${token}` : '' }
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  async function reloadData(keepPage=false){
    try{
      const newRows = await fetchData();
      rows = Array.isArray(newRows) ? newRows : [];

      if (rows.length === 0){
        info.style.display = '';
        info.textContent = 'No hay pujas todavía.';
        tableWrap.style.display = 'none';
        cardsWrap.style.display = 'none';
        return;
      }

      info.style.display = 'none';
      computeView();
      renderPage(keepPage);
    }catch(e){
      console.error(e);
      info.style.display = '';
      info.textContent = 'Error al cargar el historial';
    }
  }

  // Refresco por socket / polling
  let refreshTimer = null;
  function scheduleRefresh(){
    if (refreshTimer) return;
    refreshTimer = setTimeout(async () => {
      refreshTimer = null;
      await reloadData(true);
    }, 600);
  }

  (async function init(){
    await reloadData();
    try{
      const socket = io('http://localhost:3000', { path: '/socket.io', transports: ['websocket','polling'] });
      socket.on('auction:bid',  scheduleRefresh);
      socket.on('auction:won',  scheduleRefresh);
    }catch(e){
      console.warn('Socket.IO no disponible, usando fallback de polling.', e);
    }
    setInterval(scheduleRefresh, 20000);
  })();
})();
</script>

</body>
</html>
