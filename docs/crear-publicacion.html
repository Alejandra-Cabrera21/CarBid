<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crear publicación - CarBid</title>
  <link rel="stylesheet" href="css/panel-vendedor.css"/>
  <style>
    .form-grid{max-width:880px;margin:30px auto;background:#111;padding:24px;border-radius:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row.full{grid-template-columns:1fr}
    label{display:block;margin:8px 0 6px}
    input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#1a1a1a;color:#fff}
    .thumbs{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .thumbs img{width:110px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #333}
    .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:16px}
    .btn{padding:10px 16px;border-radius:10px;border:none;cursor:pointer}
    .btn-primary{background:#67c7d6}
    .btn-ghost{background:transparent;border:1px solid #444;color:#fff}
    small.error{color:#ff4d4f}
  </style>
</head>
<body>
  <header style="padding:12px 20px;background:#0f0f0f;display:flex;align-items:center;justify-content:space-between">
    <a href="indexvendedor.html" style="color:#fff;text-decoration:none">← Regresar</a>
    <strong>Crear publicación</strong>
    <div></div>
  </header>

  <main class="form-grid">
    <div class="row">
      <div>
        <label>Marca</label>
        <input id="marca" placeholder="Toyota" />
        <small class="error" id="err-marca"></small>
      </div>
      <div>
        <label>Modelo</label>
        <input id="modelo" placeholder="Corolla" />
        <small class="error" id="err-modelo"></small>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Año</label>
        <input id="anio" type="number" min="1900" max="2099" step="1" placeholder="2020" />
        <small class="error" id="err-anio"></small>
      </div>
      <div>
        <label>Precio base (USD)</label>
        <input id="precio" type="number" step="0.01" min="0.01" placeholder="5000.00" />
        <small class="error" id="err-precio"></small>
      </div>
    </div>

    <div class="row full">
      <div>
        <label>Descripción</label>
        <textarea id="descripcion" rows="3" placeholder="Características, estado, etc."></textarea>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Fecha y hora de cierre</label>
        <input id="fin" type="datetime-local" />
        <small class="error" id="err-fin"></small>
      </div>
      <div>
        <label>Imágenes (JPG/PNG, hasta 6, máx 2MB c/u)</label>
        <input id="images" type="file" accept=".jpg,.jpeg,.png" multiple />
        <div class="thumbs" id="thumbs"></div>
        <small class="error" id="err-images"></small>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-ghost" onclick="history.back()">Cancelar</button>
      <button class="btn btn-primary" id="btnCrear">Crear</button>
    </div>
  </main>

  <script>
  // Previsualización
  const inputFiles = document.getElementById('images');
  const thumbs = document.getElementById('thumbs');
  inputFiles.addEventListener('change', () => {
    thumbs.innerHTML = '';
    [...inputFiles.files].slice(0,6).forEach(f => {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(f);
      thumbs.appendChild(img);
    });
  });

  // Crear
  document.getElementById('btnCrear').addEventListener('click', async () => {
    // Limpia errores
    ['marca','modelo','anio','precio','fin','images'].forEach(id=>{
      const e = document.getElementById('err-'+id); if(e) e.textContent='';
    });

    const marca = document.getElementById('marca').value.trim();
    const modelo = document.getElementById('modelo').value.trim();
    const anio = document.getElementById('anio').value.trim();
    const precio = document.getElementById('precio').value.trim();
    const descripcion = document.getElementById('descripcion').value.trim();
    const fin = document.getElementById('fin').value;
    const files = [...inputFiles.files];

    let ok = true;
    if(!marca){ document.getElementById('err-marca').textContent='Requerido'; ok=false; }
    if(!modelo){ document.getElementById('err-modelo').textContent='Requerido'; ok=false; }
    if(!precio || Number(precio) <= 0){ document.getElementById('err-precio').textContent='Monto inválido'; ok=false; }
    if(!fin){ document.getElementById('err-fin').textContent='Define fecha/hora'; ok=false; }
    if(!files.length){ document.getElementById('err-images').textContent='Sube al menos 1 imagen'; ok=false; }
    if(!ok) return;

    // Construye form-data
    const fd = new FormData();
    fd.append('marca', marca);
    fd.append('modelo', modelo);
    if(anio) fd.append('anio', anio);
    fd.append('descripcion', descripcion);
    fd.append('precio_base', precio);
    fd.append('fin', fin);

    files.slice(0,6).forEach(f => fd.append('images', f));

    const token = localStorage.getItem('token');
    if(!token){ alert('Sesión no válida'); return; }

    try {
      const res = await fetch('http://localhost:3000/api/subastas?principal=0', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token },
        body: fd
      });
      const json = await res.json();
      if(res.ok){
        alert('Publicación creada');
        // Redirige al detalle o listado de creadas
        window.location.href = 'indexvendedor.html';
      }else{
        alert(json.message || 'Error al crear');
      }
    } catch (e) {
      console.error(e);
      alert('Error de conexión con el servidor');
    }
  });
  </script>
</body>
</html>
